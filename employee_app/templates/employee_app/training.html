

{# training.html - Full Admin/Trainer Dashboard with Tabs, Search & Pagination #}
{% extends 'employee_app/base.html' %}

{% block page_title %}Training Dashboard{% endblock %}

{% block content %}
<div class="content-area">
  <div class="content-card">

    <!-- Header -->
    <div class="card-header">
      <h2>Training Dashboard</h2>
      <p class="card-subtitle">Manage batches, sessions, assignments, and track overall progress</p>
      {% comment %} <div class="header-action">
        <a href="{% url 'employee_app:create_batch' %}" class="btn btn-primary">+ Create New Batch</a>
      </div> {% endcomment %}
    </div>

    <!-- Quick Stats -->
    <div class="training-stats-grid">
      <div class="stat-card">
        <h3>Active Batches</h3>
        <p class="stat-number">{{ active_batches_count }}</p>
      </div>
      <div class="stat-card">
        <h3>Total Sessions</h3>
        <p class="stat-number">{{ total_sessions }}</p>
      </div>
      <div class="stat-card">
        <h3>Pending Assignments</h3>
        <p class="stat-number">{{ pending_assignments }}</p>
      </div>
      <div class="stat-card">
        <h3>Employees Enrolled</h3>
        <p class="stat-number">{{ enrolled_employees }}</p>
      </div>
    </div>

    <!-- Search Bar -->
    <!-- Search Bar -->
      <div class="search-container">
        <form method="get" class="search-form">
          <input type="text" name="q" class="search-input" placeholder="Search by batch name, session title, assignment..." value="{{ search_query }}">
          <button type="submit" class="btn btn-primary search-btn">Search</button>
          {% if search_query %}
            <a href="{% url 'employee_app:training_dashboard' %}" class="btn clear-btn">Clear</a>
          {% endif %}
        </form>
      </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button class="tab-btn active" data-tab="batches">Batches</button>
      <button class="tab-btn" data-tab="sessions">Sessions</button>
      <button class="tab-btn" data-tab="assignments">Assignments</button>
    </div>

    <!-- Batches Tab -->
    <div id="batches" class="tab-content active">
      <div class="section-header">
        <h3>Batches</h3>
        <a href="{% url 'employee_app:create_batch' %}" class="btn btn-primary">+ Add Batch</a>
      </div>

      <div class="table-container">
        <table class="employees-biodata-table">
          <thead>
            <tr>
              <th>Batch Name</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Trainer(s)</th>
              <th>Employees</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for batch in batches %}
              <tr>
                <td><a href="{% url 'employee_app:batch_detail' batch.pk %}">{{ batch.name }}</a></td>
                <td>{{ batch.start_date|date:"d M Y" }}</td>
                <td>{{ batch.end_date|date:"d M Y" }}</td>
                <td>{{ batch.trainers.all|join:", " }}</td>
                <td>{{ batch.employees.count }}</td>
                <td><span class="status-badge {{ batch.status }}">{{ batch.get_status_display }}</span></td>
                <td>
                  <a href="{% url 'employee_app:edit_batch' batch.pk %}" class="action-icon-btn" title="Edit">✏️</a>
                  <!-- Delete button can be added later with confirmation -->
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-center py-4">No batches found{% if search_query %} matching "{{ search_query }}"{% endif %}.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Batches Pagination -->
      {% if batches.has_other_pages %}
        <div class="table-pagination" id="batches-pagination">
          <div class="pagination-controls">
            {% if batches.has_previous %}
              <button class="pagination-btn" onclick="location.href='?batches_page={{ batches.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}'">Previous</button>
            {% endif %}

            <span class="page-info">Page {{ batches.number }} of {{ batches.paginator.num_pages }} ({{ batches.paginator.count }} total)</span>

            {% if batches.has_next %}
              <button class="pagination-btn" onclick="location.href='?batches_page={{ batches.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}'">Next</button>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Sessions Tab -->
    <div id="sessions" class="tab-content">
      <div class="section-header">
        <h3>Sessions</h3>
        <a href="{% url 'employee_app:create_session' %}" class="btn btn-primary">+ Add Session</a>
      </div>

      <div class="table-container">
        <table class="employees-biodata-table">
          <thead>
            <tr>
              <th>Session Title</th>
              <th>Batch</th>
              <th>Date & Time</th>
              <th>Duration</th>
              <th>Topic</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for session in sessions %}
              <tr>
                <td><a href="{% url 'employee_app:session_detail' session.pk %}">{{ session.title }}</a></td>
                <td>{{ session.batch.name }}</td>
                <td>{{ session.date_time|date:"d M Y, H:i" }}</td>
                <td>{{ session.duration_hours }}h</td>
                <td>{{ session.agenda|truncatewords:10 }}</td>
                <td><span class="status-badge {{ session.status }}">{{ session.get_status_display }}</span></td>
                <td>
                  <a href="{% url 'employee_app:edit_session' session.pk %}" class="action-icon-btn" title="Edit">✏️</a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-center py-4">No sessions found{% if search_query %} matching "{{ search_query }}"{% endif %}.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Sessions Pagination -->
      {% if sessions.has_other_pages %}
        <div class="table-pagination" id="sessions-pagination">
          <div class="pagination-controls">
            {% if sessions.has_previous %}
              <button class="pagination-btn" onclick="location.href='?sessions_page={{ sessions.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}'">Previous</button>
            {% endif %}

            <span class="page-info">Page {{ sessions.number }} of {{ sessions.paginator.num_pages }} ({{ sessions.paginator.count }} total)</span>

            {% if sessions.has_next %}
              <button class="pagination-btn" onclick="location.href='?sessions_page={{ sessions.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}'">Next</button>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Assignments Tab -->
    <div id="assignments" class="tab-content">
      <div class="section-header">
        <h3>Assignments</h3>
        <a href="{% url 'employee_app:create_assignment' %}" class="btn btn-primary">+ Add Assignment</a>
      </div>

      <div class="table-container">
        <table class="employees-biodata-table">
          <thead>
            <tr>
              <th>Assignment Title</th>
              <th>Batch</th>
              <th>Session</th>
              <th>Due Date</th>
              <th>Max Score</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for assignment in assignments %}
              <tr>
                <td><a href="{% url 'employee_app:assignment_detail' assignment.pk %}">{{ assignment.title }}</a></td>
                <td>{{ assignment.batch.name }}</td>
                <td>{% if assignment.session %}{{ assignment.session.title }}{% else %}—{% endif %}</td>
                <td>{{ assignment.due_date|date:"d M Y" }}</td>
                <td>{{ assignment.max_score }}</td>
                <td><span class="status-badge {{ assignment.status }}">{{ assignment.get_status_display }}</span></td>
                <td>
                  <a href="{% url 'employee_app:edit_assignment' assignment.pk %}" class="action-icon-btn" title="Edit">✏️</a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-center py-4">No assignments found{% if search_query %} matching "{{ search_query }}"{% endif %}.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Assignments Pagination -->
      {% if assignments.has_other_pages %}
        <div class="table-pagination" id="assignments-pagination">
          <div class="pagination-controls">
            {% if assignments.has_previous %}
              <button class="pagination-btn" onclick="location.href='?assignments_page={{ assignments.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}'">Previous</button>
            {% endif %}

            <span class="page-info">Page {{ assignments.number }} of {{ assignments.paginator.num_pages }} ({{ assignments.paginator.count }} total)</span>

            {% if assignments.has_next %}
              <button class="pagination-btn" onclick="location.href='?assignments_page={{ assignments.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}'">Next</button>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>

  </div>
</div>




<!-- Your Pagination JS (unchanged) -->
<script>
const itemsPerPage = 10;

function paginateTable(tableId, paginationId) {
  const table = document.querySelector(tableId);
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const totalItems = rows.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);

  let currentPage = 1;

  function showPage(page) {
    rows.forEach((row, index) => {
      row.style.display = (index >= (page - 1) * itemsPerPage && index < page * itemsPerPage) ? '' : 'none';
    });

    const pagination = document.getElementById(paginationId);
    pagination.innerHTML = '';

    if (totalPages <= 1) return;

    const prevBtn = document.createElement('button');
    prevBtn.className = 'pagination-btn';
    prevBtn.textContent = 'Previous';
    prevBtn.disabled = page === 1;
    prevBtn.onclick = () => { currentPage--; showPage(currentPage); };

    const nextBtn = document.createElement('button');
    nextBtn.className = 'pagination-btn';
    nextBtn.textContent = 'Next';
    nextBtn.disabled = page === totalPages;
    nextBtn.onclick = () => { currentPage++; showPage(currentPage); };

    const info = document.createElement('span');
    info.className = 'page-info';
    info.textContent = `Page ${page} of ${totalPages} (${totalItems} total)`;

    const controls = document.createElement('div');
    controls.className = 'pagination-controls';
    controls.appendChild(prevBtn);
    controls.appendChild(info);
    controls.appendChild(nextBtn);

    pagination.appendChild(controls);
  }

  showPage(1);
}

// Tab switching + re-init pagination
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.getElementById(btn.dataset.tab).classList.add('active');

    // Re-paginate active tab
    if (btn.dataset.tab === 'batches') paginateTable('#batches table', 'batches-pagination');
    if (btn.dataset.tab === 'sessions') paginateTable('#sessions table', 'sessions-pagination');
    if (btn.dataset.tab === 'assignments') paginateTable('#assignments table', 'assignments-pagination');
  });
});

// Initialize on load
paginateTable('#batches table', 'batches-pagination');
</script>
{% endblock %}