{% extends 'employee_app/base.html' %}

{% block page_title %}Create New Training Batch{% endblock %}

{% block content %}

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        .batch-form-wrapper { max-width: 1180px; margin: 0 auto; padding: 0 15px; }
        .form-header { margin-bottom: 2.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #e2e8f0; }
        .form-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
        }
        .section-heading {
            font-size: 1.32rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 1.7rem;
            padding-bottom: 0.7rem;
            border-bottom: 2px solid #6366f1;
            width: fit-content;
        }
        .form-group { margin-bottom: 1.6rem; position: relative; }
        .form-label {
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 0.45rem;
            display: block;
        }
        .required::after { content: " *"; color: #ef4444; font-weight: 600; }
        .help-text { font-size: 0.83rem; color: #64748b; margin-top: 0.4rem; display: block; }
        .form-group.has-value .help-text.auto-hide { display: none; }
        .form-actions {
            display: flex;
            gap: 1.25rem;
            justify-content: flex-end;
            padding-top: 1.8rem;
            margin-top: 2.2rem;
            border-top: 1px solid #e2e8f0;
        }
        .btn-lg-custom { padding: 0.75rem 2.2rem; font-weight: 500; }
        .info-box {
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            padding: 1rem 1.3rem;
            border-radius: 6px;
            margin-top: 1.4rem;
            font-size: 0.91rem;
        }

        /* Select2 compact & modern */
        .select2-container--default .select2-selection--multiple {
            min-height: 50px;
            border-radius: 6px;
            border-color: #cbd5e1;
        }
        .select2-selection__rendered { padding: 6px 10px !important; display: flex; flex-wrap: wrap; gap: 6px; }
        .select2-selection__choice {
            background-color: #6366f1 !important;
            color: white !important;
            border-radius: 14px !important;
            padding: 4px 11px !important;
            font-size: 0.86rem !important;
            max-width: 260px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .select2-selection__choice__remove {
            color: white !important;
            margin-right: 5px;
            font-weight: bold;
        }
        .selection-counter {
            font-size: 0.84rem;
            color: #6366f1;
            margin-left: 8px;
            font-weight: 500;
        }

        @media (max-width: 992px) {
            .form-section { padding: 1.6rem; }
            .form-actions { flex-direction: column; gap: 1rem; }
            .btn { width: 100%; }
        }
    </style>



<div class="content-area">
    <div class="batch-form-wrapper">
        <div class="content-card">
            <div class="form-header">
                <h1 class="mb-2">Create New Training Batch</h1>
                <p class="text-muted">Define batch details, schedule and assign trainers & participants</p>
            </div>

            <form method="post" novalidate>
                {% csrf_token %}

                <!-- BASIC INFORMATION -->
                <div class="form-section">
                    <div class="section-heading">Basic Information</div>

                    <div class="row g-4">
                        <div class="col-lg-8">
                            <div class="form-group">
                                <label class="form-label required" for="{{ form.name.id_for_label }}">Batch Name</label>
                                {{ form.name }}
                                {% if form.name.errors %}<small class="text-danger">{{ form.name.errors|join:" • " }}</small>{% endif %}
                                <small class="help-text">e.g., Python Full Stack - January 2026</small>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="form-group has-value auto-hide">
                                <label class="form-label" for="{{ form.batch_code.id_for_label }}">Batch Code</label>
                                {{ form.batch_code }}
                                <small class="help-text auto-hide">Auto-generated if left empty</small>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label required" for="{{ form.start_date.id_for_label }}">Start Date</label>
                                {{ form.start_date }}
                                {% if form.start_date.errors %}<small class="text-danger">{{ form.start_date.errors|join:" • " }}</small>{% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label required" for="{{ form.end_date.id_for_label }}">End Date</label>
                                {{ form.end_date }}
                                {% if form.end_date.errors %}<small class="text-danger">{{ form.end_date.errors|join:" • " }}</small>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="{{ form.status.id_for_label }}">Status</label>
                                {{ form.status }}
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="{{ form.description.id_for_label }}">Description / Objectives</label>
                        {{ form.description }}
                        <small class="help-text">Main goals, target audience, key topics, expected outcomes...</small>
                    </div>
                </div>

                <!-- TRAINERS & PARTICIPANTS -->
                <div class="form-section">
                  <div class="section-heading">Trainers & Participants</div>

                  <div class="form-group">
                      <label class="form-label required d-flex align-items-center">
                          Trainers
                          <span class="selection-counter ms-2" id="trainers-count"></span>
                      </label>
                      {{ form.trainers }}
                      {% if form.trainers.errors %}
                          <small class="text-danger">{{ form.trainers.errors|join:" • " }}</small>
                      {% endif %}
                      <small class="help-text">Search by name or email</small>
                  </div>

                  <div class="form-group mt-4">
                      <label class="form-label d-flex align-items-center">
                          Trainees / Employees
                          <span class="selection-counter ms-2" id="employees-count"></span>
                      </label>

                      {% if form.employees.field.queryset.exists %}
                          {{ form.employees }}
                          <small class="help-text text-muted">
                              Only <strong>currently unassigned</strong> employees are shown
                          </small>
                      {% else %}
                          <div class="alert alert-info mt-2 py-2 small d-flex align-items-center">
                              <i class="fas fa-info-circle me-2"></i>
                              <span>
                                  No unassigned employees available right now.<br>
                                  <small>All active employees are already in some batch.</small>
                              </span>
                          </div>
                      {% endif %}
                  </div>

                  <div class="info-box mt-3">
                      <i class="fas fa-lightbulb me-2 text-warning"></i>
                      <strong>Note:</strong> You can add trainers and trainees now.<br>
                      You can always modify them later from the batch detail page.
                  </div>
              </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-lg-custom">
                        <i class="fas fa-plus me-2"></i> Create Batch
                    </button>
                    <a href="{% url 'employee_app:training_dashboard' %}" class="btn btn-outline-secondary btn-lg-custom">
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    function formatSelection(item) {
        if (!item.id) return item.text;
        let text = item.text.trim();
        if (text.length > 45) text = text.substring(0,42) + '…';
        return $('<span><i class="fas fa-user-tie fa-sm me-1"></i>' + text + '</span>');
    }

    $('#id_trainers, #id_employees').select2({
        placeholder: "Search by name, ID or email...",
        allowClear: true,
        width: '100%',
        templateSelection: formatSelection,
        minimumInputLength: 0,
        closeOnSelect: false
    });

    function updateCounters() {
        const tCount = $('#id_trainers').select2('data').length;
        $('#trainers-count').text(tCount ? `(${tCount})` : '');

        const eCount = $('#id_employees').select2('data').length;
        $('#employees-count').text(eCount ? `(${eCount})` : '');
    }

    $('#id_trainers, #id_employees')
        .on('change', updateCounters)
        .trigger('change');

    // Clean phantom empty values
    $('form').on('submit', function() {
        $('.select2-selection__choice').each(function() {
            const txt = $(this).text().trim();
            if (!txt || txt === '""' || txt === '"') $(this).remove();
        });
    });
});
</script>
{% endblock %}