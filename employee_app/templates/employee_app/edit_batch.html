{# batch_edit.html - Edit Existing Batch #}
{% extends 'employee_app/base.html' %}

{% block page_title %}Edit Batch{% endblock %}

{% block content %}
<div class="content-area">
  <div class="content-card">
    <div class="card-header">
      <h2>Edit Batch: Python Full Stack - Batch 2026-A</h2>
      <p class="card-subtitle">Update batch information and manage assignments</p>
    </div>

    <form method="post" class="biodata-form">
      {% csrf_token %}

      <div class="form-section">
        <h3 class="section-title">Basic Information</h3>

        <div class="form-row">
          <div class="form-group">
            <label for="id_name">Batch Name <span class="text-danger">*</span></label>
            <input type="text" name="name" id="id_name" class="form-control" 
                   value="Python Full Stack - Batch 2026-A" required>
          </div>
          <div class="form-group">
            <label for="id_start_date">Start Date <span class="text-danger">*</span></label>
            <input type="date" name="start_date" id="id_start_date" class="form-control" value="2026-01-05" required>
          </div>
          <div class="form-group">
            <label for="id_end_date">End Date <span class="text-danger">*</span></label>
            <input type="date" name="end_date" id="id_end_date" class="form-control" value="2026-06-05" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label for="id_description">Description</label>
            <textarea name="description" id="id_description" class="form-control" rows="5">Comprehensive full-stack Python training covering Django, Flask, REST APIs, database integration, and cloud deployment. Designed for intermediate developers aiming to become proficient backend/full-stack engineers.</textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="id_status">Status</label>
            <select name="status" id="id_status" class="form-control">
              <option value="pending">Pending</option>
              <option value="ongoing" selected>Ongoing</option>
              <option value="completed">Completed</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Assigned Trainers (pre-populated) -->
      <div class="form-section">
        <h3 class="section-title">Assigned Trainers</h3>
        <div class="form-group full-width">
          <label>Manage trainers (add or remove)</label>
          <div class="chips-input-container" id="trainer-container">
            <div id="trainer-chips" class="chips-display">
              <span class="chip" data-email="rajesh.kumar@company.com">Rajesh Kumar <span class="chip-remove">×</span></span>
              <span class="chip" data-email="priya.sharma@company.com">Priya Sharma <span class="chip-remove">×</span></span>
            </div>
            <input type="text" id="trainer-search" class="chips-search-input" 
                   placeholder="Search to add more trainers..." autocomplete="off">
          </div>
          <input type="hidden" name="trainers" id="trainers-hidden">
        </div>
      </div>

      <!-- Enrolled Employees (pre-populated) -->
      <div class="form-section">
        <h3 class="section-title">Enrolled Employees</h3>
        <div class="form-group full-width">
          <label>Manage enrolled employees (add or remove)</label>
          <div class="chips-input-container" id="employee-container">
            <div id="employee-chips" class="chips-display">
              <span class="chip" data-email="sai.kumar@company.com">Sai Kumar <span class="chip-remove">×</span></span>
              <span class="chip" data-email="arjun.patel@company.com">Arjun Patel <span class="chip-remove">×</span></span>
              <span class="chip" data-email="neha.singh@company.com">Neha Singh <span class="chip-remove">×</span></span>
              <span class="chip" data-email="lakshmi.devi@company.com">Lakshmi Devi <span class="chip-remove">×</span></span>
              <span class="chip" data-email="vikram.rao@company.com">Vikram Rao <span class="chip-remove">×</span></span>
              <!-- Add more as needed -->
            </div>
            <input type="text" id="employee-search" class="chips-search-input" 
                   placeholder="Search to add more employees..." autocomplete="off">
          </div>
          <input type="hidden" name="employees" id="employees-hidden">
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Update Batch</button>
        <a href="" class="btn btn-secondary">Cancel</a>
      </div>
    </form>
  </div>
</div>

<script>
// Same dummy data and setupChips function as in batch_add.html
const trainers = [
  { name: "Rajesh Kumar", email: "rajesh.kumar@company.com" },
  { name: "Priya Sharma", email: "priya.sharma@company.com" },
  { name: "John Doe", email: "john.doe@company.com" },
  { name: "Meera Nair", email: "meera.nair@company.com" },
  { name: "Suresh Reddy", email: "suresh.reddy@company.com" },
  { name: "Anil Verma", email: "anil.verma@company.com" }
];

const employees = [
  { name: "Sai Kumar", email: "sai.kumar@company.com" },
  { name: "Arjun Patel", email: "arjun.patel@company.com" },
  { name: "Neha Singh", email: "neha.singh@company.com" },
  { name: "Vikram Rao", email: "vikram.rao@company.com" },
  { name: "Lakshmi Devi", email: "lakshmi.devi@company.com" },
  { name: "Rahul Sharma", email: "rahul.sharma@company.com" },
  { name: "Pooja Mehta", email: "pooja.mehta@company.com" },
  { name: "Kiran Joshi", email: "kiran.joshi@company.com" },
  { name: "Divya Nair", email: "divya.nair@company.com" },
  { name: "Akash Reddy", email: "akash.reddy@company.com" }
];

function setupChips(containerId, searchId, chipsId, hiddenId, userList) {
  const container = document.getElementById(containerId);
  const searchInput = document.getElementById(searchId);
  const chipsDisplay = document.getElementById(chipsId);
  const hiddenInput = document.getElementById(hiddenId);

  function updateHidden() {
    const emails = Array.from(chipsDisplay.querySelectorAll('.chip'))
                        .map(chip => chip.dataset.email);
    hiddenInput.value = emails.join(',');
  }

  function addChip(user) {
    if ([...chipsDisplay.querySelectorAll('.chip')].some(c => c.dataset.email === user.email)) {
      return;
    }

    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.dataset.email = user.email;
    chip.innerHTML = `${user.name} <span class="chip-remove">×</span>`;

    chip.querySelector('.chip-remove').onclick = (e) => {
      e.stopPropagation();
      chip.remove();
      updateHidden();
    };

    chipsDisplay.appendChild(chip);
    updateHidden();
  }

  searchInput.addEventListener('input', function() {
    const query = this.value.trim().toLowerCase();
    const oldDropdown = container.querySelector('.suggestions-dropdown');
    if (oldDropdown) oldDropdown.remove();

    if (query.length < 2) return;

    const matches = userList.filter(u =>
      u.name.toLowerCase().includes(query) || u.email.toLowerCase().includes(query)
    );

    if (matches.length === 0) return;

    const dropdown = document.createElement('div');
    dropdown.className = 'suggestions-dropdown';

    matches.forEach(user => {
      const item = document.createElement('div');
      item.className = 'suggestion-item';
      item.textContent = `${user.name} (${user.email})`;
      item.onclick = () => {
        addChip(user);
        searchInput.value = '';
        dropdown.remove();
      };
      dropdown.appendChild(item);
    });

    container.style.position = 'relative';
    container.appendChild(dropdown);
  });

  document.addEventListener('click', (e) => {
    if (!container.contains(e.target)) {
      const dropdown = container.querySelector('.suggestions-dropdown');
      if (dropdown) dropdown.remove();
    }
  });

  // Initialize with existing chips
  updateHidden();
}

setupChips('trainer-container', 'trainer-search', 'trainer-chips', 'trainers-hidden', trainers);
setupChips('employee-container', 'employee-search', 'employee-chips', 'employees-hidden', employees);
</script>
{% endblock %}