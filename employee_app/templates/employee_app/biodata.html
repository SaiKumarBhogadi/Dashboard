{% extends 'employee_app/base.html' %}

{% block page_title %}Employee Biodata{% endblock %}

{% block content %}
<div class="content-area">
  <div class="content-card">
    <div class="card-header">
      <h2>All Employees</h2>
      <div class="header-row">
        <p class="card-subtitle">View and manage all employee information</p>
        <a href="{% url 'employee_app:public_biodata_form' %}" class="btn btn-primary public-btn">Public Bio Data Form</a>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="list-controls">
     
    <input type="text" id="searchEmployees" value="{{ current_search }}" 
           placeholder="Search by name, email, or ID..." class="search-input" 
           onkeyup="if(event.key === 'Enter') filterByDepartment();">

    <select id="departmentFilter" class="role-filter" onchange="filterByDepartment()">
        <option value="" {% if not current_department %}selected{% endif %}>All Departments</option>
        <option value="Software Development" {% if current_department == 'Software Development' %}selected{% endif %}>Software Development</option>
        <option value="HR" {% if current_department == 'HR' %}selected{% endif %}>HR</option>
        <option value="Finance" {% if current_department == 'Finance' %}selected{% endif %}>Finance</option>
        <option value="Operations" {% if current_department == 'Operations' %}selected{% endif %}>Operations</option>
        <option value="Training & Development" {% if current_department == 'Training & Development' %}selected{% endif %}>Training & Development</option>
    </select>


      <a href="{% url 'employee_app:pending_requests' %}" class="btn btn-primary" style="text-decoration: none;">View Requests</a>
    </div>

    <!-- Employees Table -->
    <div class="table-container">
      <div class="table-wrapper">
        <table class="employees-biodata-table">
          <thead>
            <tr>
              <th id="serial-no" style="width: 30px;">S.No</th>
              <th>Employee Name</th>
              <th>Employee ID</th>
              <th>Email</th>
              <th>Department</th>
              <th>Position</th>
              <th>Joining Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="employeesTableBody">
            {% for employee in employees %}
            <tr data-employee-name="{{ employee.first_name }} {{ employee.middle_name|default:'' }} {{ employee.last_name }}" 
                data-employee-id="{{ employee.employee_id|default:'' }}"
                data-department="{{ employee.department|default:'' }}">
              <td>{{ forloop.counter }}</td>
              <td>
                <div class="user-cell">
                  <div class="user-avatar">
                    {{ employee.first_name|slice:":1" }}{{ employee.last_name|slice:":1" | upper }}
                  </div>
                  <span>
                    {{ employee.first_name }} 
                    {{ employee.middle_name|default:'' }} 
                    {{ employee.last_name }}
                  </span>
                </div>
              </td>
              <td>{{ employee.employee_id|default:"Not Assigned" }}</td>
              <td>{{ employee.official_email|default:employee.personal_email }}</td>
              <td>{{ employee.department|default:"-" }}</td>
              <td>{{ employee.designation|default:"-" }}</td>
              <td>{{ employee.doj|date:"M d, Y"|default:"-" }}</td>
              <td>
                <a href="{% url 'employee_app:view_biodata' employee.pk %}">
                  <button class="action-icon-btn" title="View">üëÅÔ∏è</button>
                </a>
                <a href="{% url 'employee_app:edit_biodata' employee.pk %}">
                  <button class="action-icon-btn" title="Edit">‚úèÔ∏è</button>
                </a>
                <a href="{% url 'employee_app:delete_approved_employee' employee.pk %}">
                  <button class="action-icon-btn" title="Delete">üóëÔ∏è</button>
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" style="text-align:center; padding:40px; color:#666;">
                No approved employees yet.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <div class="table-pagination">
      <button class="pagination-btn" onclick="previousPageBiodata()">‚Üê Previous</button>
      <span class="pagination-info"><span class="current-page">1</span> / <span class="total-pages">1</span></span>
      <button class="pagination-btn" onclick="nextPageBiodata()">Next ‚Üí</button>
    </div>

    <!-- Export Buttons At Bottom -->
    <div class="export-buttons" style="margin-top: 25px; text-align: right;">
     <a href="{% url 'employee_app:export_biodata_excel' %}?search={{ current_search }}&department={{ current_department }}"><button class="btn btn-excel" style="padding: 10px 18px; background-color: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px; margin-bottom:5px;">
        üìÑ Export Excel
      </button></a>
      <button class="btn btn-pdf" style="padding: 10px 18px; background-color: #c62828; color: white; border: none; border-radius: 6px; cursor: pointer;">
        üìï Export PDF
      </button>
    </div>
  </div>
</div>

<script>
  // ============================================================
  // UI INTERACTION ONLY - NO BACKEND LOGIC
  // ============================================================

  const pageData = {
    currentPage: 1,
    perPage: 20
  };

 
  
function filterByDepartment() {
    const search = document.getElementById('searchEmployees').value.trim();
    const dept = document.getElementById('departmentFilter').value;
    
    let url = new URL(window.location);
    if (search) url.searchParams.set('search', search);
    else url.searchParams.delete('search');
    if (dept) url.searchParams.set('department', dept);
    else url.searchParams.delete('department');
    
    window.location.href = url.toString();
}

// Optional: Search on Enter key
document.getElementById('searchEmployees').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        filterByDepartment();
    }
});

  // Update pagination (UI only)
  function updatePaginationBiodata() {
    const visibleRows = Array.from(document.querySelectorAll('#employeesTableBody tr'))
      .filter(row => row.style.display !== 'none');
    const totalPages = Math.ceil(visibleRows.length / pageData.perPage);
    const start = (pageData.currentPage - 1) * pageData.perPage;
    const end = start + pageData.perPage;

    visibleRows.forEach((row, index) => {
      row.style.display = (index >= start && index < end) ? '' : 'none';
    });

    document.querySelector('.current-page').textContent = pageData.currentPage;
    document.querySelector('.total-pages').textContent = totalPages || 1;
  }

  function nextPageBiodata() {
    const visibleRows = Array.from(document.querySelectorAll('#employeesTableBody tr'))
      .filter(row => row.style.display !== 'none');
    const totalPages = Math.ceil(visibleRows.length / pageData.perPage);
    if (pageData.currentPage < totalPages) {
      pageData.currentPage++;
      updatePaginationBiodata();
    }
  }

  function previousPageBiodata() {
    if (pageData.currentPage > 1) {
      pageData.currentPage--;
      updatePaginationBiodata();
    }
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function () {
    updatePaginationBiodata();
  });
</script>

{% endblock %}