{% extends 'employee_app/base.html' %}

{% block page_title %}Review Biodata Request{% endblock %}

{% block content %}
<div class="content-area">
  <div class="content-card" style="max-width:1100px;">
    <div class="card-header">
      <h2>{{ bio.first_name }} {{ bio.middle_name|default:'' }} {{ bio.last_name }}</h2>
      <p class="card-subtitle">
        Submitted: {{ bio.created_at|date:"d M Y" }} • ID: #{{ bio.id }} • 
        <span class="status-badge {{ bio.status|lower }}">{{ bio.get_status_display }}</span>
      </p>
    </div>

    <form method="POST" enctype="multipart/form-data" id="reviewForm">
      {% csrf_token %}

      <!-- PERSONAL DETAILS (read-only) -->
      <div class="form-section">
        <h3 class="section-title">Personal Details</h3>

        <div class="form-row">
          <div class="form-group"><label>First Name</label><input value="{{ bio.first_name }}" readonly class="readonly"></div>
          <div class="form-group"><label>Middle Name</label><input value="{{ bio.middle_name|default:'-' }}" readonly class="readonly"></div>
          <div class="form-group"><label>Last Name</label><input value="{{ bio.last_name }}" readonly class="readonly"></div>
        </div>

        <div class="form-row">
          <div class="form-group"><label>Date of Birth</label><input value="{{ bio.dob|date:'d M Y'|default:'-' }}" readonly class="readonly"></div>
          <div class="form-group"><label>Gender</label><input value="{{ bio.gender|default:'-' }}" readonly class="readonly"></div>
          <div class="form-group"><label>Marital Status</label><input value="{{ bio.marital_status|default:'-' }}" readonly class="readonly"></div>
        </div>

        <div class="form-row">
          <div class="form-group"><label>Contact Number</label><input value="{{ bio.contact_number }}" readonly class="readonly"></div>
          <div class="form-group"><label>Emergency Contact</label><input value="{{ bio.emergency_contact|default:'-' }}" readonly class="readonly"></div>
          <div class="form-group"><label>Blood Group</label><input value="{{ bio.blood_group|default:'-' }}" readonly class="readonly"></div>
        </div>

        <div class="form-row">
          <div class="form-group"><label>Personal Email</label><input value="{{ bio.personal_email }}" readonly class="readonly"></div>
          <div class="form-group"><label>Post Applied For</label><input value="{{ bio.post_applied_for|default:'-' }}" readonly class="readonly"></div>
        </div>

        <!-- Address Fields -->
        <div class="form-row">
          <div class="form-group"><label>Address Line 1</label><input value="{{ bio.address_line1|default:'-' }}" readonly class="readonly"></div>
          <div class="form-group"><label>Address Line 2</label><input value="{{ bio.address_line2|default:'-' }}" readonly class="readonly"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>City</label><input value="{{ bio.city|default:'-' }}" readonly class="readonly"></div>
          <div class="form-group"><label>State / Province / Region</label><input value="{{ bio.state|default:'-' }}" readonly class="readonly"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Postal Code</label><input value="{{ bio.postal_code|default:'-' }}" readonly class="readonly"></div>
          <div class="form-group"><label>Country</label><input value="{{ bio.get_country_display|default:'-' }}" readonly class="readonly"></div>
        </div>

        <!-- Aadhar & PAN -->
        <div class="form-row">
          <div class="form-group"><label>Aadhar Card No</label><input value="{{ bio.aadhar_no|default:'-' }}" readonly class="readonly"></div>
          <div class="form-group"><label>PAN Card No</label><input value="{{ bio.pan_no|default:'-' }}" readonly class="readonly"></div>
        </div>

        <!-- Bank Details -->
        <div class="form-row">
          <div class="form-group"><label>Bank Name</label><input value="{{ bio.bank_name|default:'-' }}" readonly class="readonly"></div>
          <div class="form-group"><label>Bank Branch Name</label><input value="{{ bio.bank_branch|default:'-' }}" readonly class="readonly"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Account Number</label><input value="{{ bio.account_number|default:'-' }}" readonly class="readonly"></div>
          <div class="form-group"><label>Account Name</label><input value="{{ bio.account_name|default:'-' }}" readonly class="readonly"></div>
          <div class="form-group"><label>IFSC Code</label><input value="{{ bio.ifsc_code|default:'-' }}" readonly class="readonly"></div>
        </div>

        <div class="form-row">
          <div class="form-group"><label>Fresher/Experience</label><input value="{{ bio.experience_type }}" readonly class="readonly"></div>
        </div>
      </div>

      <!-- DOCUMENTS PREVIEW (All with "View" link) -->
      <div class="form-section">
        <h3 class="section-title">Uploaded Documents</h3>
        <div class="doc-grid">
          {% if bio.photo %}<div class="doc"><strong>Photo</strong><br><a href="{{ bio.photo.url }}" target="_blank">View Photo</a></div>{% endif %}
          {% if bio.resume %}<div class="doc"><strong>Resume</strong><br><a href="{{ bio.resume.url }}" target="_blank">View Resume</a></div>{% endif %}
          {% if bio.aadhar_card %}<div class="doc"><strong>Aadhar Card</strong><br><a href="{{ bio.aadhar_card.url }}" target="_blank">View Aadhar</a></div>{% endif %}
          {% if bio.pan_card %}<div class="doc"><strong>PAN Card</strong><br><a href="{{ bio.pan_card.url }}" target="_blank">View PAN</a></div>{% endif %}
          {% if bio.ssc_marksheet %}<div class="doc"><strong>10th Marksheet</strong><br><a href="{{ bio.ssc_marksheet.url }}" target="_blank">View 10th Marksheet</a></div>{% endif %}
          {% if bio.sslc_marksheet %}<div class="doc"><strong>12th Marksheet</strong><br><a href="{{ bio.sslc_marksheet.url }}" target="_blank">View 12th Marksheet</a></div>{% endif %}
          {% if bio.ug_documents %}<div class="doc"><strong>UG Documents</strong><br><a href="{{ bio.ug_documents.url }}" target="_blank">View UG Documents</a></div>{% endif %}
          {% if bio.pg_documents %}<div class="doc"><strong>PG Documents</strong><br><a href="{{ bio.pg_documents.url }}" target="_blank">View PG Documents</a></div>{% endif %}
          {% if bio.cert_document %}<div class="doc"><strong>Certification Document</strong><br><a href="{{ bio.cert_document.url }}" target="_blank">View Certification</a></div>{% endif %}
        </div>
      </div>

      <!-- EDUCATION DETAILS -->
      <div class="form-section">
        <h3 class="section-title">Education Details</h3>
        <div class="form-row">
          <div class="form-group"><label>SSC School</label><input value="{{ bio.ssc_school }}" readonly class="readonly"></div>
          <div class="form-group"><label>Year</label><input value="{{ bio.ssc_year }}" readonly class="readonly"></div>
          <div class="form-group"><label>%/Grade</label><input value="{{ bio.ssc_grade }}" readonly class="readonly"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>SSLC School</label><input value="{{ bio.sslc_school }}" readonly class="readonly"></div>
          <div class="form-group"><label>Year</label><input value="{{ bio.sslc_year }}" readonly class="readonly"></div>
          <div class="form-group"><label>%/Grade</label><input value="{{ bio.sslc_grade }}" readonly class="readonly"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>UG Degree</label><input value="{{ bio.ug_degree }}" readonly class="readonly"></div>
          <div class="form-group"><label>Institution</label><input value="{{ bio.ug_institution }}" readonly class="readonly"></div>
          <div class="form-group"><label>Year</label><input value="{{ bio.ug_year }}" readonly class="readonly"></div>
        </div>
      </div>

      <!-- WORK EXPERIENCE -->
      <div class="form-section">
        <h3 class="section-title">Work Experience</h3>
        {% if bio.work_experience %}
          {% for exp in bio.work_experience %}
            <p><strong>{{ exp.employer }}</strong> - {{ exp.designation }} ({{ exp.duration }}) <br>Email: {{ exp.email|default:'-' }}</p>
            {% if exp.certificate_path %}
              <p>
                <a href="{{ exp.certificate_path }}" target="_blank">
                  View Certificate
                </a>
              </p>
            {% else %}
              <p>No certificate uploaded.</p>
            {% endif %}

          {% endfor %}
        {% else %}
          <p>No previous experience (Fresher)</p>
        {% endif %}
      </div>

      <!-- SKILLS & REFERENCES -->
      <div class="form-section">
        <h3 class="section-title">Skills & References</h3>
        <div class="form-row">
          <div class="form-group"><label>Technical Skills</label><input value="{{ bio.technical_skills }}" readonly class="readonly"></div>
          <div class="form-group"><label>Soft Skills</label><input value="{{ bio.soft_skills|default:'-' }}" readonly class="readonly"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Reference Name</label><input value="{{ bio.reference_name|default:'-' }}" readonly class="readonly"></div>
          <div class="form-group"><label>Contact</label><input value="{{ bio.reference_contact|default:'-' }}" readonly class="readonly"></div>
        </div>
      </div>

      <!-- PROFESSIONAL DETAILS (Hidden initially - shown after Approve click) -->
      <div class="form-section" id="hrDetailsSection" style="display: none;">
        <h3 class="section-title">Professional Details (HR to Fill)</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Employee ID *</label>
            <input name="employee_id" value="{{ bio.employee_id|default:'' }}" placeholder="e.g., EMP-2025-156" >
          </div>
          <div class="form-group">
            <label>Official Email *</label>
            <input name="official_email" type="email" value="{{ bio.official_email|default:'' }}" placeholder="employee@stackly.com" >
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Designation *</label>
            <select name="designation" >
              <option value="">Select</option>
              <option {% if bio.designation == 'Junior Developer' %}selected{% endif %}>Junior Developer</option>
              <option {% if bio.designation == 'Frontend Developer' %}selected{% endif %}>Frontend Developer</option>
              <option {% if bio.designation == 'Full Stack Developer' %}selected{% endif %}>Full Stack Developer</option>
              <option {% if bio.designation == 'QA Engineer' %}selected{% endif %}>QA Engineer</option>
            </select>
          </div>
          <div class="form-group">
            <label>Department *</label>
            <select name="department" >
              <option value="">Select</option>
              <option {% if bio.department == 'Software Development' %}selected{% endif %}>Software Development</option>
              <option {% if bio.department == 'Training & Development' %}selected{% endif %}>Training & Development</option>
              <option {% if bio.department == 'HR' %}selected{% endif %}>HR</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Date of Joining *</label>
            <input type="date" name="doj" value="{{ bio.doj|date:'Y-m-d'|default:'' }}" >
          </div>
          <div class="form-group">
            <label>Work Mode</label>
            <select name="work_mode">
              <option value="Remote" {% if bio.work_mode == 'Remote' %}selected{% endif %}>Remote</option>
              <option value="Onsite" {% if bio.work_mode == 'Onsite' %}selected{% endif %}>Onsite</option>
              <option value="Hybrid" {% if bio.work_mode == 'Hybrid' %}selected{% endif %}>Hybrid</option>
            </select>
          </div>
        </div>
      </div>

      <!-- REJECT REASON (Hidden initially) -->
      <div class="form-section reject-reason" id="rejectReason" style="display:none;">
        <h3 class="section-title" style="color:#991b1b;">Reason for Rejection *</h3>
        <textarea name="reject_reason" placeholder="Please mention why this application is rejected..." style="width:100%; height:120px; padding:12px; border-radius:8px; border:1px solid #ccc;"></textarea>
      </div>

      <!-- ACTION BUTTONS -->
       {% if bio.status != 'approved' %}
      <div class="form-actions" style="margin:40px 0; padding-top:30px; border-top:2px dashed #e2e8f0;">
        <!-- Initial buttons -->
        <button type="button" id="approveBtn" class="btn btn-primary" style="background:#166534;color:white;padding:14px 40px;font-size:16px;">
          Approve & Fill HR Details
        </button>

        <button type="button" id="rejectBtn" class="btn" style="background:#dc2626;color:white;padding:14px 40px;font-size:16px;">
          Reject Application
        </button>

        <!-- Hidden Save button (shown after Approve click) -->
        <button type="submit" name="action" value="approve" id="saveApproveBtn" class="btn btn-success" style="display:none; padding:14px 40px;font-size:16px;">
          Save & Approve Employee
        </button>

        <a href="{% url 'employee_app:pending_requests' %}" class="btn btn-secondary" style="padding:14px 30px;">Back to List</a>
      </div>
      {% endif %}
      <!-- Hidden reject submit -->
      <button type="submit" name="action" value="reject" id="hiddenRejectSubmit" style="display:none;"></button>
    </form>
  </div>
</div>

<script>
  const approveBtn = document.getElementById('approveBtn');
  const saveApproveBtn = document.getElementById('saveApproveBtn');
  const rejectBtn = document.getElementById('rejectBtn');
  const rejectReason = document.getElementById('rejectReason');
  const hrDetailsSection = document.getElementById('hrDetailsSection');
  const hiddenRejectSubmit = document.getElementById('hiddenRejectSubmit');

  // Show HR fields + Save button when Approve is clicked
  approveBtn.addEventListener('click', function() {
    approveBtn.style.display = 'none';
    saveApproveBtn.style.display = 'inline-block';
    hrDetailsSection.style.display = 'block';
  });

  // Reject logic
  rejectBtn.addEventListener('click', function() {
    approveBtn.style.display = 'none';
    saveApproveBtn.style.display = 'none';
    rejectBtn.style.display = 'none';
    rejectReason.style.display = 'block';
  });

  // Confirm Reject
  rejectReason.innerHTML += `
    <div style="margin-top:20px; text-align:right;">
      <button type="button" id="confirmReject" class="btn" style="background:#dc2626;color:white;padding:12px 30px;">Confirm Reject</button>
      <button type="button" id="cancelReject" class="btn btn-secondary" style="padding:12px 30px; margin-left:10px;">Cancel</button>
    </div>
  `;

  document.getElementById('confirmReject').addEventListener('click', function() {
    const reason = document.querySelector('#rejectReason textarea').value.trim();
    if (reason === '') {
      alert('Please provide a reason for rejection.');
      return;
    }
    hiddenRejectSubmit.click();
  });

  document.getElementById('cancelReject').addEventListener('click', function() {
    rejectReason.style.display = 'none';
    approveBtn.style.display = 'inline-block';
    rejectBtn.style.display = 'inline-block';
    document.querySelector('#rejectReason textarea').value = '';
  });
</script>

{% endblock %}